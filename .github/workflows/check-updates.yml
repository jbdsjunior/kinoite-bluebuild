name: check-updates
on:
  push:
     branches:
       - main
  schedule:
    - cron: "0 */4 * * *"  # every 4 hours
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  check-and-trigger:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Install Skopeo
        run: |
          sudo apt-get update
          sudo apt-get -y install skopeo

      - name: Ensure gh auth
        run: gh auth status
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # AMD base image used by recipes/image-recipe-amd.yml
      - name: Check Main Image (for AMD)
        id: check_amd
        run: |
          set -euo pipefail
          DIGEST=$(skopeo inspect docker://quay.io/fedora/fedora-kinoite --format '{{.Digest}}')
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Check AMD Cache
        id: cache_amd
        uses: actions/cache@v5
        with:
          path: ~/.cache-amd
          key: upstream-main-${{ steps.check_amd.outputs.digest }}

      - name: Trigger AMD Build
        if: steps.cache_amd.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          gh workflow run image-build-amd.yml --ref main --repo "${{ github.repository }}"
          mkdir -p ~/.cache-amd
          echo "${{ steps.check_amd.outputs.digest }}" > ~/.cache-amd/upstream-digest.txt
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # NVIDIA base image used by recipes/image-recipe-nvidia.yml
      - name: Check Nvidia Base Image
        id: check_nvidia
        run: |
          set -euo pipefail
          DIGEST=$(skopeo inspect docker://ghcr.io/blue-build/base-images/fedora-kinoite-nvidia:latest --format '{{.Digest}}')
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Check Nvidia Cache
        id: cache_nvidia
        uses: actions/cache@v5
        with:
          path: ~/.cache-nvidia
          key: upstream-nvidia-${{ steps.check_nvidia.outputs.digest }}

      - name: Trigger Nvidia Build
        if: steps.cache_nvidia.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          gh workflow run image-build-nvidia.yml --ref main --repo "${{ github.repository }}"
          mkdir -p ~/.cache-nvidia
          echo "${{ steps.check_nvidia.outputs.digest }}" > ~/.cache-nvidia/upstream-digest.txt
        env:
          GITHUB_TOKEN: ${{ github.token }}
