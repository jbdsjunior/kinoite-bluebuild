# --- 1. MEMORY & SWAP OPTIMIZATIONS (64GB RAM + ZRAM) ---

# Disable read-ahead for swap (Optimized for ZRAM/SSD random access)
vm.page-cluster = 0

# Aggressive adjustments to avoid STALLS during memory pressure
vm.watermark_boost_factor = 0
vm.watermark_scale_factor = 125

# --- WRITEBACK CACHE TUNING (Corrected for 64GB RAM) ---
# Previous settings used fixed bytes which were too low for this hardware.
# Switched to ratios to leverage the massive RAM pool.

# Start writing to disk in background when 5% of RAM is dirty (~3.2 GB)
# This prevents I/O spikes by trickling data to the NVMe earlier but efficiently.
vm.dirty_background_ratio = 5

# Force synchronous write (stop processes) only when 10% of RAM is dirty (~6.4 GB)
# Gives plenty of headroom for heavy compilations or file transfers before blocking.
vm.dirty_ratio = 10

# Preference for retaining file structure cache (dentry/inode) in RAM
# 50 = More aggressive at keeping directory structures cached (Great for git/compiling)
vm.vfs_cache_pressure = 50

# --- ZRAM PRIORITY ---
# Keep aggressive usage of ZRAM (compressed RAM) over disk swap.
# With 64GB RAM, we want to avoid touching disk swap at all costs.
vm.swappiness = 90

# --- 2. NETWORK PERFORMANCE (BBR & TCP) ---
# Google BBR congestion control algorithm (Better throughput/latency)
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# Enable TCP Fast Open (Reduces handshake latency)
net.ipv4.tcp_fastopen = 3

# --- 3. SECURITY & PRIVACY ---
# Restrict ptrace scope (Mitigates code injection attacks)
kernel.yama.ptrace_scope = 1

# IPv6 Privacy Extensions (Temporary addresses to hinder tracking)
net.ipv6.conf.all.use_tempaddr = 2
net.ipv6.conf.default.use_tempaddr = 2

# Keep Router Advertisements enabled (required for regular IPv6 client SLAAC)
net.ipv6.conf.all.accept_ra = 1
net.ipv6.conf.default.accept_ra = 1

# Ignore ICMP redirects (MITM attack mitigation)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Basic protection against SYN Flood and spoofing
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_rfc1337 = 1

# --- 4. SYSTEM LIMITS (Gaming, Wine & IDEs) ---
# Increase open file limit (Crucial for Wine/Proton and heavy Flatpaks)
fs.file-max = 2097152

# Increase Inotify limits (Essential for VSCode, IntelliJ, Syncthing)
fs.inotify.max_user_instances = 512
fs.inotify.max_user_watches = 524288

# High limit for games/loads with many memory regions (Steam/Wine essential)
vm.max_map_count = 1048576

# --- 5. ADVANCED NETWORK OPTIMIZATION (High-Bandwidth) ---
# Increase backlog for simultaneous connections (P2P/Servers)
net.core.netdev_max_backlog = 16384
net.core.somaxconn = 8192

# Increase TCP read/write buffers (Ideal for Gigabit/Wifi 6+ networks)
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 16384 16777216
