# /etc/systemd/resolved.conf
# Fedora Linux 2026 - ControlD (Malware Blocking) + Cloudflare Fallback
# Optimized for Privacy and Security

[Resolve]
# -------------------------------------------------------------------------
# Primary DNS: ControlD (Free DNS - Malware Blocking Profile p2)
# Syntax: IP#TLS_Server_Name ensures strict validation for DoT
# -------------------------------------------------------------------------
DNS=76.76.2.11#p2.freedns.controld.com 76.76.10.11#p2.freedns.controld.com 2606:1a40::11#p2.freedns.controld.com 2606:1a40:1::11#p2.freedns.controld.com

# -------------------------------------------------------------------------
# Fallback DNS: Cloudflare (Speed & Redundancy)
# Used only if ControlD fails
# -------------------------------------------------------------------------
FallbackDNS=1.1.1.1#cloudflare-dns.com 1.0.0.1#cloudflare-dns.com 2606:4700:4700::1111#cloudflare-dns.com 2606:4700:4700::1001#cloudflare-dns.com

# -------------------------------------------------------------------------
# Routing Logic
# -------------------------------------------------------------------------
# Force all domains to use the Global DNS settings above.
# Without this, local router DNS might still be used for some queries.
Domains=~.

# -------------------------------------------------------------------------
# Privacy & Security Protocols
# -------------------------------------------------------------------------
# Opportunistic: Use TLS (port 853) if available, fall back to plain text if blocked.
# Change to 'yes' (Strict) if you want to fail-closed on TLS errors.
DNSOverTLS=opportunistic

# Validate DNSSEC signatures (allow-downgrade prevents breakage on signed domains)
DNSSEC=allow-downgrade

# -------------------------------------------------------------------------
# Local Network Noise Reduction
# -------------------------------------------------------------------------
# Disable MulticastDNS and LLMNR to reduce local traffic and fingerprinting
# Note: This might make resolving local hostnames like 'printer.local' harder.
MulticastDNS=no
LLMNR=no

# Do not resolve single-label names (e.g., 'server') via global DNS
ResolveUnicastSingleLabel=no

# -------------------------------------------------------------------------
# Caching & System Integration
# -------------------------------------------------------------------------
# Read local /etc/hosts file for manual overrides
ReadEtcHosts=yes

# Enable caching to speed up browsing
Cache=yes

# Do not cache queries originating from localhost itself (security/consistency)
CacheFromLocalhost=no

# Listen on 127.0.0.53 for local applications
DNSStubListener=yes