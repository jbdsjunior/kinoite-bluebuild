# /etc/systemd/resolved.conf
# Fedora Linux 2026 - ControlD (Malware Blocking) + Cloudflare Fallback
# Optimized for Privacy and Security

[Resolve]
# -------------------------------------------------------------------------
# Primary DNS: ControlD (Free DNS - Malware Blocking Profile p2)
# Syntax: IP#TLS_Server_Name ensures strict validation for DoT
# -------------------------------------------------------------------------
# DNS=76.76.2.11#p2.freedns.controld.com 76.76.10.11#p2.freedns.controld.com 2606:1a40::11#p2.freedns.controld.com 2606:1a40:1::11#p2.freedns.controld.com

# Primary: ControlD (Ads & Malware Blocking Profile - p2)
# IPv4: 76.76.2.2, 76.76.10.2
# IPv6: 2606:1a40::2, 2606:1a40:1::2
# Hostname for DoT: p2.freedns.controld.com
DNS=76.76.2.2#p2.freedns.controld.com 76.76.10.2#p2.freedns.controld.com 2606:1a40::2#p2.freedns.controld.com 2606:1a40:1::2#p2.freedns.controld.com

# -------------------------------------------------------------------------
# Fallback DNS: Cloudflare (Speed & Redundancy)
# Used only if ControlD fails
# -------------------------------------------------------------------------
FallbackDNS=1.1.1.1#cloudflare-dns.com 1.0.0.1#cloudflare-dns.com 2606:4700:4700::1111#cloudflare-dns.com 2606:4700:4700::1001#cloudflare-dns.com

# -------------------------------------------------------------------------
# Routing Logic
# -------------------------------------------------------------------------
# Force all domains to use the Global DNS settings above.
# Without this, local router DNS might still be used for some queries.
# Domains=~.

# -------------------------------------------------------------------------
# Privacy & Security Protocols
# -------------------------------------------------------------------------
# Strict: Always require DNS over TLS (port 853).
# If DoT is unavailable, DNS resolution should fail closed.
# DNSOverTLS=yes
DNSOverTLS=opportunistic


# Strict DNSSEC validation (fail closed on invalid/broken signatures).
# DNSSEC=yes
DNSSEC=allow-downgrade

# -------------------------------------------------------------------------
# Local Network Noise Reduction
# -------------------------------------------------------------------------
# Disable MulticastDNS and LLMNR to reduce local traffic and fingerprinting
# Note: This might make resolving local hostnames like 'printer.local' harder.
MulticastDNS=no
LLMNR=no

# Do not resolve single-label names (e.g., 'server') via global DNS
ResolveUnicastSingleLabel=no

# -------------------------------------------------------------------------
# Caching & System Integration
# -------------------------------------------------------------------------
# Read local /etc/hosts file for manual overrides
ReadEtcHosts=yes

# Enable caching to speed up browsing
Cache=yes

# Do not cache queries originating from localhost itself (security/consistency)
CacheFromLocalhost=no

# Listen on 127.0.0.53 for local applications
DNSStubListener=yes
